@{
    ViewBag.Title = "Capture Image";
}

<h2>Capture Image</h2>

<button id="start-camera">Start Camera</button>
<button id="switch-camera" style="display:none;">Switch Camera</button>
<video id="video" width="320" height="240" autoplay></video>
<button id="capture" style="display:none;">Capture Image</button>
<canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

<form id="imageForm" action="/UploadedImages" method="post">
    <input type="hidden" name="imageData" id="imageData" />
    <input type="submit" value="Upload Image" />
</form>

<script>
    let currentStream = null;
    let currentFacingMode = "environment"; // default to back camera

    document.getElementById('start-camera').addEventListener('click', async function () {
        await startCamera();
        document.getElementById('switch-camera').style.display = 'inline';
        document.getElementById('capture').style.display = 'inline';
    });

    document.getElementById('switch-camera').addEventListener('click', async function () {
        currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
        await startCamera();
    });

    async function startCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
        }

        const constraints = {
            video: {
                facingMode: currentFacingMode
            }
        };

        try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            currentStream = stream;
            const video = document.getElementById('video');
            video.srcObject = stream;
        } catch (err) {
            console.error('Error accessing camera: ', err);
        }
    }

    document.getElementById('capture').addEventListener('click', function () {
        const canvas = document.getElementById('canvas');
        const video = document.getElementById('video');
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        const dataUrl = canvas.toDataURL('image/png');
        document.getElementById('imageData').value = dataUrl;
    });
</script>
